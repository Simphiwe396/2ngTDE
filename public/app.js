// Minimal app.js - loads products and manages cart
export const Cart = (()=>{const KEY='clinchglow_cart_v1';function load(){try{const raw=localStorage.getItem(KEY);return raw?JSON.parse(raw):[]}catch(e){return []}}function save(v){localStorage.setItem(KEY,JSON.stringify(v));}return{get(){const raw=load();const prods=window.__CG_PRODUCTS||[];return raw.map(i=>({qty:i.qty,product:prods.find(p=>p.id===i.id)})).filter(Boolean);},add(product,qty=1){const items=load();const idx=items.findIndex(i=>i.id===product.id);if(idx>=0)items[idx].qty+=qty;else items.push({id:product.id,qty});save(items);},update(id,qty){const items=load();const idx=items.findIndex(i=>i.id===id);if(idx<0)return;items[idx].qty=qty;if(items[idx].qty<=0)items.splice(idx,1);save(items);},remove(id){const items=load();save(items.filter(i=>i.id!==id));},clear(){save([]);}}})();

async function fetchProducts(){try{const r=await fetch('/products.json');const j=await r.json();window.__CG_PRODUCTS=j.products;window.allProducts=j.products;return j.products}catch(e){console.error(e);return []}}

function showToast(t){const el=document.getElementById('toast');el.textContent=t;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),2000)}

async function init(){const products=await fetchProducts();const cats=['All',...new Set(products.map(p=>p.category))];renderCategories(cats);renderProducts('All',products);updateCartCount();}
function renderCategories(categories){const el=document.getElementById('categoryTabs');el.innerHTML='';categories.forEach((c,i)=>{const btn=document.createElement('button');btn.className='tab-btn'+(i===0?' active':'');btn.textContent=c;btn.onclick=()=>{document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderProducts(c)};el.appendChild(btn)})}
async function renderProducts(category,productsArg){const products=productsArg||await fetchProducts();const grid=document.getElementById('productGrid');grid.innerHTML='';const filtered=(typeof category==='string')?products.filter(p=>category==='All'||p.category===category):category;filtered.forEach(p=>{const card=document.createElement('article');card.className='card';card.innerHTML=`<img src='${p.image}' alt='${p.name}' style='width:100%;height:160px;object-fit:cover;border-radius:8px'><h3>${p.name}</h3><div class='price'>R ${p.price.toFixed(2)}</div><div style='margin-top:12px;display:flex;gap:8px'><button class='btn btn-primary'>Add to cart</button></div>`;card.querySelector('.btn-primary').onclick=()=>{Cart.add(p,1);updateCartCount();showToast('Added to cart')};grid.appendChild(card)})}
function updateCartCount(){const items=JSON.parse(localStorage.getItem('clinchglow_cart_v1')||'[]');const qty=items.reduce((s,i)=>s+(i.qty||0),0);document.getElementById('cartCount').textContent=qty}

window.addEventListener('DOMContentLoaded',init);
